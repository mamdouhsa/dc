<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>ğŸ§ª Danger Tablosu Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }
        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button.clear {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        #output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .info { color: #9cdcfe; }
        .timestamp {
            color: #808080;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Supabase Operasyon_AÃ§Ä±klama Test</h1>
        
        <div class="btn-group">
            <button onclick="testRead()">ğŸ“– Operasyon Verilerini Oku</button>
            <button onclick="testUpdate()">âœï¸ Test GÃ¼ncelleme (Devre DÄ±ÅŸÄ±)</button>
            <button class="clear" onclick="clearOutput()">ğŸ—‘ï¸ Temizle</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vhxjyfappvmtwfdkhkoc.supabase.co';
        const SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoeGp5ZmFwcHZtdHdmZGtoa29jIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczMjU0MjkyNywiZXhwIjoyMDQ4MTE4OTI3fQ.VWnKC7B_5oqKhthYCVzMoHuSUxYmH9O6A3xjcwwm7NQ';

        // Page load event
        window.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ Test sayfasÄ± hazÄ±r!', 'success');
            log(`ğŸŒ Supabase URL: ${SUPABASE_URL}`, 'info');
            log(`ğŸ”‘ Service Key: ${SERVICE_KEY.substring(0, 50)}...`, 'info');
            log('', 'info');
            log('ğŸ‘† YukarÄ±daki butonlarla test edebilirsiniz.', 'warning');
            log('â•'.repeat(50), 'info');
        });

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString('tr-TR');
            const line = `<span class="timestamp">[${timestamp}]</span> <span class="${type}">${message}</span>\n`;
            output.innerHTML += line;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
            log('ğŸ§¹ Ã‡Ä±ktÄ± temizlendi. Test baÅŸlatmak iÃ§in yukarÄ±daki butonlara tÄ±klayÄ±n.', 'info');
        }

        async function testRead() {
            log('â³ Operasyon_AÃ§Ä±klama tablosundan veriler okunuyor...', 'info');
            
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/Operasyon_AÃ§Ä±klama?select=*&limit=20`,
                    {
                        headers: {
                            'apikey': SERVICE_KEY,
                            'Authorization': `Bearer ${SERVICE_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                log(`ğŸ“¡ HTTP Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… BaÅŸarÄ±lÄ±! ${data.length} kayÄ±t bulundu.`, 'success');
                    
                    if (data.length > 0) {
                        log('ğŸ“‹ Ä°lk 20 kayÄ±t:', 'info');
                        log('â•'.repeat(50), 'info');
                        data.forEach((row, index) => {
                            const rowInfo = `${index + 1}. ${JSON.stringify(row).substring(0, 80)}...`;
                            log(rowInfo, 'success');
                        });
                        log('â•'.repeat(50), 'info');
                        log(`ğŸ“Š Toplam: ${data.length} kayÄ±t`, 'success');
                    } else {
                        log('âš ï¸ Tablo boÅŸ! Veri yok.', 'warning');
                    }
                } else if (response.status === 401) {
                    log('âŒ 401 UNAUTHORIZED!', 'error');
                    log('ğŸ”’ Row Level Security (RLS) AÃ‡IK!', 'error');
                    log('', 'info');
                    log('Ã‡Ã–ZÃœM:', 'warning');
                    log('1. Supabase Dashboard â†’ SQL Editor', 'info');
                    log('2. Åu SQL\'i Ã§alÄ±ÅŸtÄ±r:', 'info');
                    log('   ALTER TABLE "Operasyon_AÃ§Ä±klama" DISABLE ROW LEVEL SECURITY;', 'warning');
                    log('3. Bu sayfayÄ± yenile ve tekrar test et.', 'info');
                } else {
                    const errorText = await response.text();
                    log(`âŒ Hata: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`âŒ AÄŸ hatasÄ±: ${error.message}`, 'error');
            }
        }

        async function testUpdate() {
            log('â³ Test gÃ¼ncelleme yapÄ±lÄ±yor (Hat: 104 â†’ 00:45:00)...', 'info');
            
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/Takip?Name=eq.104`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SERVICE_KEY,
                            'Authorization': `Bearer ${SERVICE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ UyarÄ±: '00:45:00' })
                    }
                );

                log(`ğŸ“¡ HTTP Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                if (response.ok || response.status === 204) {
                    log('âœ… GÃ¼ncelleme baÅŸarÄ±lÄ±!', 'success');
                    log('ğŸ“ Hat 104 iÃ§in UyarÄ±: 00:45:00 olarak ayarlandÄ±.', 'success');
                    log('', 'info');
                    log('ğŸ“– Kontrol etmek iÃ§in "Danger Verilerini Oku" butonuna tÄ±klayÄ±n.', 'info');
                } else if (response.status === 401) {
                    log('âŒ 401 UNAUTHORIZED!', 'error');
                    log('ğŸ”’ RLS yazma izni yok!', 'error');
                    log('', 'info');
                    log('Ã‡Ã–ZÃœM: YukarÄ±daki okuma testindeki SQL\'i Ã§alÄ±ÅŸtÄ±rÄ±n.', 'warning');
                } else {
                    const errorText = await response.text();
                    log(`âŒ Hata: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`âŒ AÄŸ hatasÄ±: ${error.message}`, 'error');
            }
        }

        // Sayfa yÃ¼klendiÄŸinde
        window.addEventListener('load', () => {
            log('ğŸš€ Test sayfasÄ± hazÄ±r!', 'success');
            log(`ğŸŒ Supabase URL: ${SUPABASE_URL}`, 'info');
            log(`ğŸ”‘ Service Key: ${SERVICE_KEY.substring(0, 40)}...`, 'info');
            log('', 'info');
            log('ğŸ‘† YukarÄ±daki butonlarla test edebilirsiniz.', 'info');
            log('â•'.repeat(50), 'info');
        });
    </script>
</body>
</html>
